name: CD Pipeline (GCP)

on:
  # push:
  #   branches:
  #     - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to GKE
    runs-on: ubuntu-latest
    environment: production

    steps:
      # Step 1: Checkout the code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.12

      # Step 3: Authenticate to Google Cloud
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      # Step 4: Set up Cloud SDK
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      # Step 5: Configure Docker to use gcloud as credential helper
      - name: Configure Docker for GCR
        run: |
          gcloud auth configure-docker gcr.io

      # Step 6: Set up .env file
      - name: Set up .env.${{ secrets.APP_ENV }} file
        run: |
          echo "APP_ENV=${{ secrets.APP_ENV }}" > .env.${{ secrets.APP_ENV }}
          echo "GCP_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }}" >> .env.${{ secrets.APP_ENV }}
          echo "GUARDRAILS_API_KEY=${{ secrets.GUARDRAILS_API_KEY }}" >> .env.${{ secrets.APP_ENV }}
          echo "QDRANT_API_KEY=${{ secrets.QDRANT_API_KEY }}" >> .env.${{ secrets.APP_ENV }}
          echo "QDRANT_URL=${{ secrets.QDRANT_URL }}" >> .env.${{ secrets.APP_ENV }}
          echo "LANGSMITH_API_KEY=${{ secrets.LANGSMITH_API_KEY }}" >> .env.${{ secrets.APP_ENV }}
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env.${{ secrets.APP_ENV }}
          echo "TEMPERATURE=${{ secrets.TEMPERATURE }}" >> .env.${{ secrets.APP_ENV }}
          echo "SPARSE_MODEL_NAME=${{ secrets.SPARSE_MODEL_NAME }}" >> .env.${{ secrets.APP_ENV }}
          echo "REPOS_CONFIG=${{ secrets.REPOS_CONFIG }}" >> .env.${{ secrets.APP_ENV }}
          echo "LLM_MODEL_NAME=${{ secrets.LLM_MODEL_NAME }}" >> .env.${{ secrets.APP_ENV }}
          echo "LEN_EMBEDDINGS=${{ secrets.LEN_EMBEDDINGS }}" >> .env.${{ secrets.APP_ENV }}
          echo "DENSE_MODEL_NAME=${{ secrets.DENSE_MODEL_NAME }}" >> .env.${{ secrets.APP_ENV }}
          echo "CONCURRENT_COMMENTS=${{ secrets.CONCURRENT_COMMENTS }}" >> .env.${{ secrets.APP_ENV }}
          echo "COLLECTION_NAME=${{ secrets.COLLECTION_NAME }}" >> .env.${{ secrets.APP_ENV }}
          echo "CHUNK_SIZE=${{ secrets.CHUNK_SIZE }}" >> .env.${{ secrets.APP_ENV }}
          echo "BATCH_SIZE=${{ secrets.BATCH_SIZE }}" >> .env.${{ secrets.APP_ENV }}

      # Step 7: Build and push Docker image to GCR
      - name: Build and push Docker image to GCR
        run: |
          IMAGE_NAME=fastapi-app
          GCR_URI=gcr.io/${{ secrets.GCP_PROJECT_ID }}/${IMAGE_NAME}

          docker build -f docker/${{ secrets.APP_ENV }}.Dockerfile -t ${IMAGE_NAME}:latest .
          docker tag ${IMAGE_NAME}:latest ${GCR_URI}:latest
          docker tag ${IMAGE_NAME}:latest ${GCR_URI}:${{ github.sha }}
          docker push ${GCR_URI}:latest
          docker push ${GCR_URI}:${{ github.sha }}

      # Step 8: Get GKE credentials
      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ secrets.GKE_CLUSTER_NAME }} \
            --region ${{ secrets.GCP_REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }}

      # Step 9: Deploy to GKE
      - name: Deploy to GKE
        run: |
          # Update image in deployment
          kubectl set image deployment/fastapi-deployment \
            fastapi=gcr.io/${{ secrets.GCP_PROJECT_ID }}/fastapi-app:${{ github.sha }} \
            -n my-app

          # Wait for rollout to complete
          kubectl rollout status deployment/fastapi-deployment -n my-app

      # Step 10: Verify deployment
      - name: Verify deployment
        run: |
          kubectl get pods -n my-app
          kubectl get services -n my-app
