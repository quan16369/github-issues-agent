apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: update-manifest
  namespace: tekton-pipelines
spec:
  description: Update Helm chart values with new image tag
  params:
    - name: git-url
      description: Git repository URL
      type: string
    - name: git-revision
      description: Git branch to update
      type: string
      default: main
    - name: values-file
      description: Path to Helm values.yaml file
      type: string
      default: helm_charts/github-agent/values.yaml
    - name: image-name
      description: Image name to update
      type: string
    - name: image-tag
      description: New image tag
      type: string
    - name: git-email
      description: Git user email
      type: string
      default: "tekton@github-agent.com"
    - name: git-name
      description: Git user name
      type: string
      default: "Tekton Pipeline"
  workspaces:
    - name: source
      description: Workspace for git repository
    - name: git-credentials
      description: Git credentials for push
      optional: true
  steps:
    - name: clone-repo
      image: gcr.io/tekton-releases/github.com/tektoncd/pipeline/cmd/git-init:v0.40.2
      workingDir: $(workspaces.source.path)
      env:
        - name: WORKSPACE_SSH_DIRECTORY_BOUND
          value: $(workspaces.git-credentials.bound)
        - name: WORKSPACE_SSH_DIRECTORY_PATH
          value: $(workspaces.git-credentials.path)
      script: |
        #!/bin/sh
        set -e
        
        if [ "${WORKSPACE_SSH_DIRECTORY_BOUND}" = "true" ] ; then
          cp -R "${WORKSPACE_SSH_DIRECTORY_PATH}" ~/.ssh
          chmod 700 ~/.ssh
          chmod -R 400 ~/.ssh/*
        fi
        
        git clone $(params.git-url) repo
        cd repo
        git checkout $(params.git-revision)
        
    - name: update-image
      image: alpine/helm:3.13.0
      workingDir: $(workspaces.source.path)/repo
      script: |
        #!/bin/sh
        set -e
        
        echo "Updating values file: $(params.values-file)"
        echo "Image: $(params.image-name):$(params.image-tag)"
        
        # Update image tag in values.yaml using sed
        sed -i "s|tag:.*|tag: \"$(params.image-tag)\"|g" $(params.values-file)
        
        echo "Values updated"
        cat $(params.values-file)
        
    - name: commit-and-push
      image: gcr.io/tekton-releases/github.com/tektoncd/pipeline/cmd/git-init:v0.40.2
      workingDir: $(workspaces.source.path)/repo
      env:
        - name: WORKSPACE_SSH_DIRECTORY_BOUND
          value: $(workspaces.git-credentials.bound)
        - name: WORKSPACE_SSH_DIRECTORY_PATH
          value: $(workspaces.git-credentials.path)
      script: |
        #!/bin/sh
        set -e
        
        if [ "${WORKSPACE_SSH_DIRECTORY_BOUND}" = "true" ] ; then
          cp -R "${WORKSPACE_SSH_DIRECTORY_PATH}" ~/.ssh
          chmod 700 ~/.ssh
          chmod -R 400 ~/.ssh/*
        fi
        
        # Configure git
        git config user.email "$(params.git-email)"
        git config user.name "$(params.git-name)"
        
        # Commit changes
        git add $(params.manifest-dir)/kustomization.yaml
        
        if git diff --cached --quiet; then
          echo "No changes to commit"
          exit 0
        fi
        
        git commit -m "Update image to $(params.image-name):$(params.image-tag)

        Updated by Tekton Pipeline
        Image: $(params.image-name):$(params.image-tag)
        Manifest: $(params.manifest-dir)"
        
        # Push changes
        git push origin $(params.git-revision)
        
        echo "Changes committed and pushed to $(params.git-revision)"
