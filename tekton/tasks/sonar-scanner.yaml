apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: sonar-scanner
  namespace: tekton-pipelines
spec:
  description: Run SonarQube code quality and security analysis
  params:
    - name: sonar-host-url
      description: SonarQube server URL
      type: string
    - name: sonar-project-key
      description: Project key in SonarQube
      type: string
    - name: source-dir
      description: Source code directory
      type: string
      default: "."
  workspaces:
    - name: source
      description: Workspace containing source code
  steps:
    - name: sonar-scan
      image: sonarsource/sonar-scanner-cli:5.0
      workingDir: $(workspaces.source.path)
      env:
        - name: SONAR_HOST_URL
          value: $(params.sonar-host-url)
        - name: SONAR_TOKEN
          valueFrom:
            secretKeyRef:
              name: sonarqube-token
              key: token
      script: |
        #!/bin/bash
        set -e
        
        echo "Running SonarQube analysis..."
        echo "Project: $(params.sonar-project-key)"
        echo "Source: $(params.source-dir)"
        
        sonar-scanner \
          -Dsonar.projectKey=$(params.sonar-project-key) \
          -Dsonar.sources=$(params.source-dir) \
          -Dsonar.host.url=${SONAR_HOST_URL} \
          -Dsonar.login=${SONAR_TOKEN} \
          -Dsonar.python.version=3.12 \
          -Dsonar.exclusions=**/*_test.py,**/tests/**,**/__pycache__/**,**/.venv/**
        
        echo "SonarQube analysis completed"
